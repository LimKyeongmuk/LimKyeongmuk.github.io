---
title: "자이카 센서장치"
excerpt: ""

categories:
  - ROS
tags:
  - ROS
  - RVIZ Odometry
---
# 자이카 센서장치
### 자이카에 장착된 센서 장치
- 자이카 하드웨어
  - 센서
    - IMU 센서(9축)
    - 카메라
    - 라이다 센서
    - 초음파 센서
  
  - 모터
    - 구동 모터
    - 서브 모터
  
  - 메인 프로세서
    - 센터를 관리하는 소프트웨어

- Xycar-A 모듈 시스템 구성도
  - 프로세서 모듈인 NVIDIA TX2에 USB device로 센서들이 연결되어  있음
  
- Xycar-B 모듈 시스템 구성도
  - USB 카메러
  - IMU 센서
  - 아두이노를 거쳐서 초음파 센서 8개
  
### 카메라 센서
- 카메라 센서
  - 1080P USB 카메라
    - USB2.0, UVC 지원
    - 170도 어안렌즈
    - CMOS OV2710 Sensor
    - 120-fps(640x480), 30-fps(1920x1080)

- RGB(Red, Green, Blue)
  - RGB는 Red, Green, Blue 빛의 3원색
    - 세상의 모든 색은 Red, Green, Blue의 3가지 색상 요소로 분해 가능
    - 빛의 삼원색과 색의 삼원색은 다름
  
  - 그림/동영상 데이터
    - Red, Green, Blue 각각의 색상을 1byte(8bits)로 표현
    - 3개 bytes
    - Full-HD 1920x1080 화면을 가득 채우는 그림의 크기는 1920x1080x3bytes=6Mbytes
  
- 색의 인식과 저장
  - 전구에서 R, G, B 필터를 통과해서 전체 색으로 보임
  
- 해상도, PPI, 화소수
  - 해상도: 가로, 세로의 전구의 수
  - PPI: 같은 1인치(2.54cm)를 몇 개로 나눠서 사용하는지
  - 화소수
  
- 카메라 센서의 기능
  - 영상 촬영
    - 연속된 사진을 찍어 이미지 파일로 전송
    - 최대 해상도 1920x1080
    - 하지만 Xycar에서는 640x480 사진을 초당 30장 촬영
    - 보통은 압축하여 전송하므로 더 높은 해상도와 초당 더 많은 프레임 전송이 가능함
  
- 카메라 기능 조정
  - 노출도 Exposure
    - 주변 밝기에 따른 이미지 밝기 변화
    - 자율 주행에서는 노출도가 낮은 것이 좋음
  
  - 자동초점조정(Auto-focus)
    - 자율주행에는 이 기능이 있으면 좋지 않음
    - 실제로 실습할 때 이 기능을 끄고 하기
  
### IMU 센서
- IMU 센서 개요
  - IMU(Inerial Measurement Unit)
    - 관성 측정 장치: 가속도계와 회전속도계, 자력계의 조합을 사용하여 어떤 물체(질량)에 가해지는 힘
    - 회전 각속도 등을 측정하는 장치
  
- 변위, 속도, 가속도
  - 변위는 직선 이동이면 거리, 각도 이동이면 몇 도 회전했는지 나타내는 것
  - 변위를 미분하면 속도, 속도를 미분하면 가속도
  - 가속도를 적분하면 속도, 속도를 적분하면 변위
  
- 자이카에서 사용하는 IMU 센서
  - 6축 IMU 센서 MPU-6050
    - 가속도 센서 Accelerometer
      - 직선 방향 가속도(움직임) 감지, 중력가속도 감지
      
    - 자이로 센서 Gyroscope
      - 회전 속도인 각속도를 감지
      - ROLL: 기울어짐
      - PITCH: 상승하강
      - YAW: 좌, 우회전
  
  - 9축 IMU 센서 SparkFun 9DoF Razor IMU M0
    - 가속도 센서 Accelerometer
      - 직선 방향 가속도(움직임) 감지, 중력가속도 감지
      
    - 자이로 센서 Gyroscope
      - 회전 속도인 각속도를 감지
      - ROLL: 기울어짐
      - PITCH: 상승하강
      - YAW: 좌, 우회전
      
    - 지자계 센서 Magnetometer
      - N극 방향 감지, 동서남북 방위각 감지
  
- 가속도 센서
  - 가속 센서(Accelerometer)
    - MEMS(Micro-Electro-Mechanical Systems) 기술로 만들어지는 센서
    - 반도체 칩 안에 입체적인 구조물 만들고 이 구조물이 외부의 힘에 따라 움직이는 것을 전기적 신호로 바꾸어 출력
    - X, Y, Z 축 방향의 직선 움직임과 기울어짐의 자세 파악
  
  - 응용
    - 스마트 폰 
    - 만보계
  
- 자이로 센서(Gyro Sensor)
  - 자이로 센서
    - MEMS(Micro-Electro-Mechanical Systems) 기술 기반
    - X, Y, Z 축을 기준으로 한 회전 움직임
  
  - 응용
    - Game UI
    - 리모콘
    - 실내 GPS(Dead Reckoning)
  
- 지자기 센서
  - 지자기 센서 (Magnetometer Sensor)
    - 3축 나침반
    - 방위 알려주는 디지털 나침반 기능
  
  - 지도와 결합하여 다양한 응용 제공
    - 커피숍 찾아가기
    - 증강현실(Augmented Reality)
  
- 세 방향의 축
  - 직교하는 세 방향의 축
    - Roll
      - 이동 방향에 대하여 평행한 축 주위의 회전각을 나타냄
      - 차량이 코너링할 때 옆으로 기울어지는 것을 감지할 수 있음
      
    - Pitch
      - 이동 방향에 대해서 수직을 이루는 축 주위의 회전각을 나타냄
      - 차량이 언덕을 올라가는 것과 내려오는 것을 감지할 수 있음
  
    - Yaw
      - 이동 방향에 대해서 수직을 이루는 축 주위의 회전각을 나타냄
      - 차량의 좌회전/우회전 회전하는 것을 감지할 수 있음
  
### 라이다 센서
- 라이다
  - 1 채널, 2D 라이다
  - 채널 1이라는 것은 광선이 한 번 나온다는 뜻
  - 실제 사용하는 64채널은 64개의 광선이 세로로 있어서 한 번에 쏨
  - 0.9 degree, 4000 sampling, 15cm~18m
  
- 라이다? 레이다?
  - 라이다(Light Imaging Detection and Ranging))
    - 레이저 신호의 반사파를 이용
    - 짧은 주파수로 작은 물체도 감지가 가능
    - 정확한 3D 단색 이미지 구성 가능
    - 재질 정보도 Detect 할 수 있음
    
  - 레이다(Radio Detection and Ranging)
    - 전파 신호의 반사파를 이용
    - 속도 감지 가능(경찰의 과속측정기에 사용)
    - 구름 많은 날씨 환경 및 야간에도 손쉽게 작동
    - LIDAR보다 더 긴 작동거리를 제공
  
  - 멀티 채널 라이다
    - 위아래 스캐닝 가능
    - 사람, 차량, 벽, 기둥 인식 가능
  
- 라이다의 장애물 감지 기능
  - 돌발 장애물
    - 라이다를 이용하여 전방 장애물 감지
    - 0~360도, 1도 단위로 거리 센싱
    - (X, Y) 좌표로 변환하여 장애물 위치 판단(진행방향에 장애물이 있으면 정지)

- 라이다의 센싱 데이터
  - 360도 회전하면서 1도씩 전방에 있는 장애물까지의 거리를 센싱
  - 360개의 Array 데이터를 만들어 사용
  - 극 좌표를 직교 좌표계로 바꿔서 사용
  
### 초음파 센서
- 초음파
  - Ultrasonic Wave
  - 인간의 귀가 들을 수 있는 가청 주파수 대역보다 높은 진동수로 발생하는 파동
  - 가청 주파수는 사람마다 다르지만, 약 20Hz ~ 20kHz
  - Ultrasound: 20kHz~2MHz
  - 초음파 센서는 초음파를 이용해서 센서로부터 사물까지의 직선거리를 측정
  
- 초음파 센서
  - 모두 8개(전방 3개, 후방 3개, 좌측 1개, 우측 1개)
  - 아두이노 1개에 초음파 센서 4개씩 USB로 연결
  - 초음파 센서 모듈(HC-SR04)
  
- 초음파 센서의 동작
  - 시그널
    - Vcc: 센서 부품에 전력 공급(DC 5V)
    - GND: 회로의 그라운드에 연결
    - Trig: 센서를 동작시키기 위한 트리거 시그널(입력)
    - Echo: 거리 측정 결과를 전달하기 위한 시그널(출력)
  
  - 동작 원리
    - 송신부에서 초음파를 발사함
    - 초음파가 물체에서 반사됨
    - 반사된 초음파가 수신부에서 감지됨
    - 송신과 수신 사이의 시간 간격을 기준으로 물체까지의 거리를 계산함
  
- 초음파 센서의 동작 시나리오
  - 시작 > 초음파 발사와 수신 > 시간차 출력
    - 아두이노가 TRIC 핀에 10us 동안 High 신호를 내보냄
    - 초음파 센서가 40kHz 초음파 펄스(pulse)를 여덟 개 만들어 물체로 보냄
    - 물체에 반사된 초음파 펄스가 되돌아가서 초음파 센서에 수신됨
    - 센서는 송신과 수신의 시간차에 비례하는 길이의 펄스를 Echo 핀으로 출력함
  
- 초음파 센서를 이용한 거리 측정
  - 소리의 속도는 초속 340m (1초에 340미터 이동)
    - 1cm 이동하는데 약 29us 소요
  
  - 송신과 수신의 시간차 = 초음파의 왕복 이동시간
  - 물체까지의 거리 = (송신과 수신의 시간차(us)/2)/29us 센치미터
  
- 초음파 센서의 측정 오류
  - 쏜 신호가 되돌아와야 하는데 모두 흡수되거나 다른 곳으로 튕겨나가면?
  
# 자이카 센서 ROS 패키지
### 자이카 ROS 패키지 구성

### 카메라 센서를 위한 ROS 노드와 토픽

### IMU 센서를 위한 ROS 노드와 토픽

### 라이다 센서를 위한 ROS 노드와 토픽

# 자이카 IMU 센서 활용
### IMU 센서를 위한 ROS 노드와 토픽

### IMU 데이터에서 Roll, Pitch, Yaw 값 출력

# IMU 데이터 시각화
### IMU 데이터 시각화 Plug-in 설치
- rviz_imu_plugin.tgx 파일 복사
- IMU Viewer - 플러그인 추가
- IMU Viewer - Displays Tab 설정
  - RVIZ Displays Tab - Topic
    - 수신할 토픽 입력란
    - IMU의 자세 데이터는 /imu 토픽으로 publish 되고 있으므로 빈 공간 클릭한 후 /imu 나오면 이걸 선택
  
  - RVIZ Displays Tab - Box Properties
    - 박스 속성
    - IMU 데이터를 시각화하기 위해 육면체를 Grid 위에 출력할 수 있음
    - Scale은 육면체의 크기
    - Color은 육면체의 색
    - Alpha는 육면체의 투명도
  
  - RVIZ Displays Tab - Axes Properties
    - 축 속성
    - IMU 데이터를 시각화하기 위해 축을 Grid 위에 출력할 수 있음
    - Scale은 축의 크기
  
- RVIZ 세팅 상태 저장 - imu_3d.rviz

### RVIZ에서 IMU 센서 데이터 시각화
- 과제 목표
  - imu_data.txt에는 imu 센서가 보내는 내용을 적어넣음
  - imu_generator.py가 imu 메시지 타입에 맞게 데이터를 제공
  - 주어진 imu_data.txt 파일에서 한 줄씩 읽어와 Imu 메시지 타입에 맞게 가공
  - 가공된 데이터를 /imu 토픽에 넣은 후 RVIZ 뷰어를 향해 발행함

- 파일 구성
  - 런치 파일: imu_generator.launch
  - 파이썬 파일: imu_generator.py
  - RVIZ 파일: imu_generator.rviz
  
- imu_data.txt
  - imu_data.txt 포맷: "roll: value, pitch: value, yaw: value"
  - value 값은 모두 라디안 값으로 기록
  - 실제 토픽에는 쿼터니언 값을 담는 것을 기억하기
  
- Imu 메시지 타입
  - sensor_msgs/Imu
    - header
    - orientation: Roll, Pitch. Yaw가 아닌 x, y, z, w를 담음(from tf.transforamtions import quaternion_from_euler)
  
- imu_data_maker.py
  - IMU가 보내는 토픽을 받아서 imu_data.txt 파일을 만드는 파이썬 코드(반대일을 하는 코드)