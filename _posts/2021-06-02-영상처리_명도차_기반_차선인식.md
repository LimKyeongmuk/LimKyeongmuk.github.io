---
title: "OpenCV 자이카 카메라 활용"
excerpt: ""

categories:
  - OpenCV
tags:
  - OpenCV
  - Python
  - Xycar
  - 차선인식
---
### 명도차 기반 차선 인식 과정과 필요한 영상처리 기능
- 차선을 따라 주행하기
  - USB 카메라와 OpenCV를 이용하고 차선을 인식하고 인식된 차선을 따라 스스로 주행할 수 있는 자율주행
  - 직선구간 주행과 곡선구간 주행방법이 살짝 다를 수 있음
  
- 차선을 인식하여 운전
  - 차선 추종 주행
    - 좌우 차선을 찾아내어 차선을 벗어나지 않게끔 주행하기
    - 카메라 입력으로 취득한 영상에서 적절한 영역을 잘라내기
    - 이진화를 한 다음 우선 바깥에서 중앙으로 가면서 흰색 점을 찾기
    - 그 점 주위에 사격형을 쳐서 사각형 안에 있는 흰색점의 개수를 구하기(기준 개수 이상이면 차선으로 인식)
  
- OpenCV 기반의 영상처리
  - 차선을 찾기 위한 작업
    - Image Read(카메라 영상신호를 이미지로 읽기)
    - GrayScale(흑백 이미지로 변환)
    - Gaussian Blur(노이즈 제거)
    - HSV Binary(HSV 기반으로 이진화 처리)
    - ROI(관심영역 잘라내기)
  
- 차선 검출을 위한 영상처리
  - 컬러(bgr8) 이미지를 흑백(grayscale) 이미지로 변환
    - cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    
  - 차선 인식에 방해가 되는 노이즈 제거
    - cv2.GaussainBlur(gray, (5, 5), 0)
  
  - HSV 기반 이진화 방법으로 차선 추출
    - cv2.inRange(hsv, (0, 0, 70), (131, 255, 255))
  
  - 외곽선을 추출해서 차선을 찾을 수 있음(Canny Edge Detector 이용)
    - cv2.Canny(blur, 20, 190)
  
  - 사각형 안에 있는 흰색 점의 개수를 세서 일정 개수 이상이면 녹색으로 표시
    - 이미지를 잘라서 사용하면서 cv2.countNonZero(area) 사용
- 노이즈 제거(Gaussain Blur)
  - Gaussian Blur 원리
    - 각 픽셀에 5x4 윈도우를 올려놓고, 그 영역 안에 포함되는 값을 모두 더한 뒤 이것을 25로 나누어 인접한 점들의 밝기의 산술 평균을 구하는 방식으로 노이즈를 제거함
    - 윈도우의 크기를 크게 할수록 더 부드러운 blur를 얻게 됨
  
### 영상에서 차선 찾기 프로그래밍
- 카메라 영상에서 차선 검출하기
  - 트랙 영상에서 특정 영역을 ROI로 설정하여 차선위치를 검출
    - BGR > HSV > 이진화
  
  - 검출된 차선을 녹색 사각형으로 표시하기
    - 이진화된 이미지를 BGR로 변환하여 색상을 가지는 사각형이 표식될 수 있도록
  
- 관심영역 ROI 설정
  - 동영상 파일의 프레임 크기: 640x480
    - 세로 좌표 430~450 영역을 ROI로 설정(차량 바로 앞의 차선)
    - 가로 좌표 0~200, 440~640을 각각 왼쪽과 오른쪽 차선을 발견하기 위한 구간으로 설정
    - 이좌표는 차선을 잘 잡아낼 수 있는 영역을 정하는 것이므로 상황에 따라 달라짐
  
- 영역 내 흰색 픽셀의 개수를 기준으로 차선 인식
  - 녹색 사각형은 검출된 차선의 위치를 표시
    - 사각형 안의 흰 픽셀 수를 기준으로 검출 영역의 가로x세로 크기는 20픽셀x10픽셀
    - 위 200개(20x10) 픽셀들 중 160개(80%) 이상이 흰색이면 차선으로 간주하기
    - 모든 값은 변경 가능(상황에 맞게)
  
- 차선 인식
  - 잘라낸 영역에서 한 픽셀씩 움직이면서 찾기
  - 중앙에서 바깥으로 가면서부터 왼쪽과 오른쪽 끝에서 중앙으로 가면서 찾는 것이 좋은지 생각해보기
